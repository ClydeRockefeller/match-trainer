<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>åŒåˆ—è‹±æ–‡-ä¸­æ–‡é…å¯¹è®­ç»ƒå™¨</title>
<link rel="manifest" href="data:application/manifest+json,{
  'name': 'åŒåˆ—é…å¯¹è®­ç»ƒå™¨',
  'short_name': 'MatchTrainer',
  'start_url': '.',
  'display': 'standalone',
  'background_color': '#0b132b',
  'theme_color': '#5bc0be',
  'icons': [{'src': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjNWJjMGJlIi8+CjxwYXRoIGQ9Ik0xMjggMTI4TDk2IDE2MEw2NCAxMjhMOTYgMTYwTDMyIDY0TDY0IDMyTDk2IDY0TDMyIDE2MEw2NCAxMjhMOTYgMTYwTDMyIDMyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjgiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K', 'sizes': '192x192', 'type': 'image/svg+xml'}]
}"/>
<style>
:root{--bg:#0b132b;--card:#1c2541;--accent:#5bc0be;--accent2:#6fffe9;--text:#e6eefc;--muted:#9fb3c8;--warn:#ffb703;--bad:#ef476f;--good:#06d6a0;}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Microsoft YaHei,Arial}
.wrap{max-width:1100px;margin:0 auto;padding:16px 12px 40px}
h1{font-size:20px;margin:8px 0 12px}
.tab-bar{display:flex;gap:0;background:var(--card);border-radius:12px 12px 0 0;margin-bottom:0;padding:8px 0}
.tab-btn{flex:1;padding:10px 16px;border:0;background:transparent;color:var(--muted);cursor:pointer;border-radius:12px 12px 0 0;font-weight:500}
.tab-btn.active{color:var(--accent);background:var(--bg)}
.tab-content{display:none;background:var(--card);border-radius:0 12px 12px;padding:16px}
.tab-content.active{display:block}
.bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;background:var(--card);padding:12px;border-radius:12px;margin-bottom:12px}
.bar>div{display:flex;gap:8px;align-items:center}
input[type="text"],input[type="number"],select{background:#0f1c3a;border:1px solid #2b395f;color:var(--text);padding:8px 10px;border-radius:8px;min-width:180px}
input[type="file"]{color:var(--muted)}
textarea{width:100%;min-height:140px;background:#0f1c3a;border:1px solid #2b395f;color:var(--text);padding:10px;border-radius:10px;resize:vertical}
button{background:var(--accent);color:#062726;border:0;padding:8px 12px;border-radius:10px;cursor:pointer;transition:.2s;font-size:14px;touch-action:manipulation}
button.ghost{background:transparent;border:1px solid #2b395f;color:var(--text)}
button.warn{background:var(--warn);color:#1c1400}
button.bad{background:var(--bad)}
button.good{background:var(--good);color:#003322}
button:disabled{opacity:.5;cursor:not-allowed}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.col{background:var(--card);border-radius:12px;padding:12px;min-height:280px}
.col h2{font-size:16px;margin:0 0 10px;color:var(--muted)}
.item{display:block;width:100%;text-align:left;background:#0f1c3a;color:var(--text);border:1px solid #2b395f;border-radius:10px;padding:12px;margin-bottom:8px;white-space:normal;overflow-wrap:break-word;max-height:60px;overflow:hidden;transition:all 0.3s ease;min-height:44px;box-sizing:border-box}
.item.sel{outline:3px solid var(--accent2);border-color:var(--accent2);background:#2b395f !important;transform:scale(1.02)}
.item:hover{background:#2b395f;transform:translateY(-1px)}
.item:active{transform:scale(0.98)}
.msg{margin-top:8px;min-height:24px;color:var(--muted)}
.flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.grow{flex:1}
.progress{height:10px;background:#0f1c3a;border-radius:999px;overflow:hidden;border:1px solid #2b395f}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:.3s}
.small{font-size:12px;color:var(--muted)}
.list-item{display:flex;justify-content:space-between;align-items:center;padding:8px;background:#0f1c3a;border-radius:8px;margin-bottom:4px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;justify-content:center;align-items:center}
.modal-content{background:var(--card);padding:20px;border-radius:12px;max-width:400px;width:90%;max-height:80vh;overflow-y:auto}
.close{position:absolute;top:10px;right:20px;color:var(--muted);font-size:24px;cursor:pointer}
.badge{background:var(--good);padding:4px 8px;border-radius:999px;font-size:12px;margin-left:8px}
.review-date{font-size:10px;color:var(--muted);display:block;margin-top:4px;}
.loading{display:none;text-align:center;padding:20px;color:var(--accent)}
.loading.active{display:block}
.skeleton{height:44px;background:#2b395f;border-radius:10px;margin-bottom:8px;animation:shimmer 1.5s infinite}
@keyframes shimmer{0%{background-position:-468px 0}100%{background-position:468px 0}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.success{animation:fadeIn .5s;color:var(--good)}
.error{animation:shake .5s;color:var(--bad)}
.preview-count{font-size:12px;color:var(--muted);margin-top:4px;text-align:right}
.rating-modal .modal-content{max-width:300px;text-align:center}
.rating-btns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:12px 0}
.rating-btn{background:var(--card);border:1px solid var(--accent);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;transition:.2s}
.rating-btn:hover{background:var(--accent)}
.rating-btn.selected{background:var(--accent);color:#062726}
.sync-status{margin-top:8px;padding:8px;background:#0f1c3a;border-radius:8px;text-align:center}
.locked{opacity:0.5;pointer-events:none}
.tip-box{background:#0f1c3a;border:1px solid var(--accent);padding:10px;border-radius:8px;margin:8px 0}
@media(max-width:720px){.grid{grid-template-columns:1fr};.bar{flex-direction:column;align-items:stretch};.item{padding:16px;font-size:16px};button{padding:12px 16px;font-size:16px};.wrap{padding:8px}}
@media(max-width:540px){.wrap{padding:8px};.grid{gap:8px};h1{font-size:18px}}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ”¤ åŒåˆ—è‹±æ–‡-ä¸­æ–‡é…å¯¹è®­ç»ƒå™¨</h1>

  <div class="tab-bar">
    <button class="tab-btn active" data-tab="train">ä»Šæ—¥è®­ç»ƒ</button>
    <button class="tab-btn" data-tab="review">å›é¡¾æ¨¡å¼</button>
    <button class="tab-btn" data-tab="manage">æ•°æ®ç®¡ç†</button>
    <button class="tab-btn" data-tab="settings">è®¾ç½®</button>
  </div>

  <div id="train" class="tab-content active">
    <div class="bar">
      <div><label>ä¼šè¯å</label><input type="text" id="sessionName" placeholder="e.g. 2025-11-14-åŸºç¡€" value="ä»Šæ—¥è®­ç»ƒ"/></div>
      <div><label>æ˜¾ç¤ºå¯¹æ•°</label><input type="number" id="visibleCount" min="3" max="12" value="6"/></div>
      <div class="flex"><input type="file" id="file" accept=".csv,.txt,.json"/><button class="ghost" id="loadBtn">åŠ è½½/é‡ç½®</button><button class="ghost" id="demoBtn">ç¤ºä¾‹æ•°æ®</button></div>
      <div class="grow"></div>
      <div class="small" id="stats">è¿›åº¦ 0/0 | é”™é¢˜ 0</div>
    </div>
    <textarea id="dataBox" placeholder='ç²˜è´´è¯ç»„: en,zh æˆ– en\tzh æˆ– en,zh,sentence\ne.g.\ntake care,å°å¿ƒ,Please take care of yourself.\nrun fast,è·‘å¾—å¿«,The rabbit can run fast.'></textarea>
    <div class="preview-count" id="previewCount">æœ‰æ•ˆè¡Œ: 0</div>
    <div class="tip-box" id="forceTip" style="display:none">å¼ºåˆ¶å¤ä¹ é”å®šï¼šè¯·å®Œæˆ<span id="remainingCount">0</span>é¡¹å¤ä¹ åè§£é”æ–°å†…å®¹ã€‚<button class="ghost" id="skipForce">ä¸´æ—¶è·³è¿‡</button></div>
    <div class="flex"><button class="good" id="ttsBtn">æµ‹è¯•å‘éŸ³</button><button class="warn" id="forceCheck">æ£€æŸ¥å¼ºåˆ¶</button><button class="ghost" id="pauseBtn">æš‚åœ</button><button class="ghost" id="resetBtn">é‡ç½®</button><button class="ghost" id="fullscreenBtn">å…¨å±</button></div>
    <div class="loading" id="loading"><div>åŠ è½½ä¸­...</div><div class="skeleton"></div><div class="skeleton"></div></div>
    <div class="grid">
      <div class="col"><h2>è‹±æ–‡</h2><div id="leftCol"></div></div>
      <div class="col"><h2>ä¸­æ–‡</h2><div id="rightCol"></div></div>
    </div>
    <div class="msg" id="msg"></div>
    <div class="flex"><div class="progress grow"><span id="bar" style="width:0%"></span></div><div class="small" id="counter">0%</div></div>
  </div>

  <div id="review" class="tab-content">
    <div class="bar"><button class="ghost" id="loadReview">åŠ è½½ä»Šæ—¥å¿…å®¡</button><button class="ghost" id="notifyOpt">é€šçŸ¥è®¾ç½®</button></div>
    <div id="reviewList" class="list-item" style="display:none">æ— å¾…å®¡é¡¹</div>
    <div class="grid" id="reviewGrid" style="display:none"><!-- å¤ç”¨åŒ¹é…UI --></div>
  </div>

  <div id="manage" class="tab-content">
    <h2>ä¼šè¯åˆ—è¡¨</h2>
    <div id="sessionList"></div>
    <button class="ghost" id="exportCSV">å¯¼å‡ºé”™é¢˜CSV</button><button class="bad" id="clearSession">åˆ é™¤å½“å‰</button><button class="ghost" id="backupJSON">å¤‡ä»½JSON</button><button class="ghost" id="openRecycle">æ‰“å¼€å›æ”¶ç«™</button>
    <div class="sync-status" id="syncStatus">åŒæ­¥çŠ¶æ€: æœ¬åœ° | <button class="ghost" id="syncCloud">äº‘åŒæ­¥</button></div>
  </div>

  <div id="settings" class="tab-content">
    <h2>ç®—æ³•è®¾ç½®</h2>
    <div class="bar"><label>å¼ºåˆ¶é˜ˆå€¼</label><input type="number" id="forceThreshold" min="30" max="90" value="50"/>%<button class="ghost" id="saveSettings">ä¿å­˜</button></div>
    <h2>é€šçŸ¥ä¸PWA</h2>
    <div class="bar"><label>å¯ç”¨é€šçŸ¥</label><input type="checkbox" id="enableNotify"/><label>å¯ç”¨TTS</label><input type="checkbox" id="enableTTS" checked/><label>TTSå£éŸ³</label><select id="ttsAccent"><option value="en-US">ç¾éŸ³</option><option value="en-GB">è‹±éŸ³</option></select></div>
    <h2>æ‰©å±•</h2>
    <div class="bar"><label>å¯ç”¨ä¾‹å¥</label><input type="checkbox" id="enableSentence" checked/><label>æ»‘åŠ¨åŒ¹é…</label><input type="checkbox" id="enableSwipe" checked/><label>ä¸´æ—¶è·³è¿‡å¼ºåˆ¶</label><input type="checkbox" id="allowSkipForce" checked/></div>
    <div class="tip-box">é¦–æ¬¡ä½¿ç”¨æç¤ºï¼šå¼ºåˆ¶å¤ä¹ å¯ä¿æŠ¤å­¦ä¹ æ•ˆæœï¼Œä¸´æ—¶è·³è¿‡å…è®¸çµæ´»æ“ä½œï¼Œä½†å»ºè®®å®Œæˆä»¥ä¼˜åŒ–è®°å¿†ã€‚[web:129]</div>
  </div>
</div>

<!-- æ¨¡æ€æ¡†: ç¡®è®¤è¦†ç›– -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="confirmTitle">ç¡®è®¤æ“ä½œ</h3>
    <p id="confirmText"></p>
    <div class="flex"><button class="bad" id="confirmYes">ç¡®è®¤</button><button class="ghost" id="confirmNo">å–æ¶ˆ</button></div>
  </div>
</div>

<!-- å›æ”¶ç«™æ¨¡æ€ -->
<div id="recycleModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>å›æ”¶ç«™</h3>
    <div id="recycleList"></div>
    <button class="good" id="restoreAll">å…¨éƒ¨è¿˜åŸ</button>
  </div>
</div>

<!-- è´¨é‡è¯„çº§æ¨¡æ€ -->
<div id="ratingModal" class="modal rating-modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>è¯„ä¼°å›å¿†è´¨é‡ (0-5)</h3>
    <p>5: å®Œç¾<br>4: æ­£ç¡®ä½†çŠ¹è±«<br>3: æ­£ç¡®ä½†å›°éš¾<br>2: é”™è¯¯ä½†æ˜“è®°<br>1: é”™è¯¯ä½†è®°å¾—<br>0: å®Œå…¨å¿˜è®°</p>
    <div class="rating-btns">
      <button class="rating-btn" data-q="5">5</button>
      <button class="rating-btn" data-q="4">4</button>
      <button class="rating-btn" data-q="3">3</button>
      <button class="rating-btn" data-q="2">2</button>
      <button class="rating-btn" data-q="1">1</button>
      <button class="rating-btn" data-q="0">0</button>
    </div>
    <p id="ratingItem"></p>
  </div>
</div>

<script>
(() => {
  // å…¨å±€å…ƒç´ 
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const DB_NAME = 'MatchTrainerDB';
  const DB_VERSION = 1;
  const STORE_NAME = 'sessions';
  const RECYCLE_STORE = 'recycle';
  let db = null;
  let currentSession = null;
  let items = []; // {id, en, zh, sentence?, mastered: false, errors: 0, reviews: 0, lastReview: 0, nextReview: 0, stubborn: false, efactor: 2.5, repetitions: 0, interval: 0}
  let pool = [];
  let visibleLeft = [];
  let visibleRight = [];
  let selLeft = null, selRight = null;
  let wrongCount = 0;
  let forceThreshold = 50;
  let enableNotify = false;
  let enableTTS = true;
  let ttsAccent = 'en-US';
  let enableSentence = true;
  let enableSwipe = true;
  let allowSkipForce = true;
  let paused = false;
  let touchStartX = 0, touchStartY = 0;
  let synth = null;
  let pendingRating = null;
  let forceLocked = false; // æ–°å¢ï¼šå¼ºåˆ¶é”çŠ¶æ€
  let remainingForce = 0; // å‰©ä½™å¼ºåˆ¶å¤ä¹ é¡¹
  const el = {
    tabs: qsa('.tab-btn'),
    contents: qsa('.tab-content'),
    sessionName: qs('#sessionName'),
    visibleCount: qs('#visibleCount'),
    file: qs('#file'),
    dataBox: qs('#dataBox'),
    previewCount: qs('#previewCount'),
    loadBtn: qs('#loadBtn'),
    demoBtn: qs('#demoBtn'),
    ttsBtn: qs('#ttsBtn'),
    forceCheck: qs('#forceCheck'),
    left: qs('#leftCol'),
    right: qs('#rightCol'),
    msg: qs('#msg'),
    stats: qs('#stats'),
    bar: qs('#bar'),
    counter: qs('#counter'),
    sessionList: qs('#sessionList'),
    loadReview: qs('#loadReview'),
    notifyOpt: qs('#notifyOpt'),
    exportCSV: qs('#exportCSV'),
    clearSession: qs('#clearSession'),
    backupJSON: qs('#backupJSON'),
    openRecycle: qs('#openRecycle'),
    syncCloud: qs('#syncCloud'),
    syncStatus: qs('#syncStatus'),
    forceThreshold: qs('#forceThreshold'),
    enableNotify: qs('#enableNotify'),
    enableTTS: qs('#enableTTS'),
    ttsAccent: qs('#ttsAccent'),
    enableSentence: qs('#enableSentence'),
    enableSwipe: qs('#enableSwipe'),
    allowSkipForce: qs('#allowSkipForce'),
    saveSettings: qs('#saveSettings'),
    confirmModal: qs('#confirmModal'),
    confirmTitle: qs('#confirmTitle'),
    confirmText: qs('#confirmText'),
    confirmYes: qs('#confirmYes'),
    confirmNo: qs('#confirmNo'),
    recycleModal: qs('#recycleModal'),
    recycleList: qs('#recycleList'),
    restoreAll: qs('#restoreAll'),
    ratingModal: qs('#ratingModal'),
    ratingItem: qs('#ratingItem'),
    pauseBtn: qs('#pauseBtn'),
    resetBtn: qs('#resetBtn'),
    fullscreenBtn: qs('#fullscreenBtn'),
    loading: qs('#loading'),
    forceTip: qs('#forceTip'),
    remainingCount: qs('#remainingCount'),
    skipForce: qs('#skipForce'),
  };

  // SM-2 ç®—æ³•å®ç°
  function sm2Update(item, quality) {
    item.repetitions = (item.repetitions || 0) + 1;
    if (quality < 3) {
      item.repetitions = 1;
      item.interval = 1;
    } else {
      if (item.repetitions === 1) {
        item.interval = 1;
      } else if (item.repetitions === 2) {
        item.interval = 6;
      } else {
        item.interval = Math.max(1, Math.round(item.interval * item.efactor));
      }
    }
    const delta = 0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02);
    item.efactor = Math.max(1.3, item.efactor + delta);
    item.nextReview = Date.now() + item.interval * 86400000;
    item.lastReview = Date.now();
    checkForce(); // æ›´æ–°åæ£€æŸ¥å¼ºåˆ¶çŠ¶æ€
  }

  // åˆå§‹åŒ– TTS
  function initTTS() {
    if ('speechSynthesis' in window) {
      synth = window.speechSynthesis;
      synth.cancel();
    } else {
      flash('æµè§ˆå™¨ä¸æ”¯æŒTTSï¼Œè¯·æ£€æŸ¥è®¾ç½®ã€‚', 'warn');
    }
  }

  // TTS æ’­æ”¾ (æ·»åŠ æŒ¯åŠ¨åé¦ˆ)
  function speak(text, isError = false) {
    if (!enableTTS || !synth) return;
    if (document.visibilityState === 'hidden') {
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') speak(text, isError);
      }, { once: true });
      return;
    }
    synth.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = ttsAccent;
    utter.rate = isError ? 1.2 : 0.9;
    utter.pitch = isError ? 1.2 : 1.0;
    utter.volume = 0.8;
    utter.onerror = () => flash('TTSæ’­æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚', 'error');
    synth.speak(utter);
    if ('vibrate' in navigator && isError) navigator.vibrate(200); // é”™è¯¯æŒ¯åŠ¨
  }

  // é”™è¯¯å¤„ç†åŒ…è£…
  function safeAsync(fn, onError = null) {
    return async (...args) => {
      try { return await fn(...args); } catch (e) { console.error(e); if (onError) onError(e); flash('æ“ä½œå‡ºé”™ï¼Œè¯·é‡è¯•ã€‚', 'error'); }
    };
  }

  // IndexedDB åˆå§‹åŒ–
  async function initDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(DB_NAME, DB_VERSION);
      request.onerror = () => reject(request.error);
      request.onsuccess = () => { db = request.result; resolve(); };
      request.onupgradeneeded = e => {
        db = e.target.result;
        if (!db.objectStoreNames.contains(STORE_NAME)) {
          db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        }
        if (!db.objectStoreNames.contains(RECYCLE_STORE)) {
          db.createObjectStore(RECYCLE_STORE, { keyPath: 'id' });
        }
      };
    });
  }

  // ä¿å­˜ä¼šè¯
  const saveSession = safeAsync(async () => {
    if (!db) return;
    let name = el.sessionName.value.trim() || 'Untitled';
    const id = currentSession || Date.now().toString();
    const data = {
      id,
      name,
      items: items.map(i => ({...i})),
      wrongCount,
      timestamp: Date.now(),
    };
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    await new Promise((res, rej) => {
      const req = store.put(data);
      req.onsuccess = res;
      req.onerror = rej;
    });
    currentSession = id;
    await renderSessions();
    updateSyncStatus();
    checkForce(); // ä¿å­˜åæ£€æŸ¥å¼ºåˆ¶
  });

  // åŠ è½½ä¼šè¯
  const loadSession = safeAsync(async (sessionId) => {
    if (!db) return null;
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    return new Promise((res, rej) => {
      const req = store.get(sessionId);
      req.onsuccess = () => {
        const data = req.result;
        if (data) {
          items = data.items.map((item, idx) => ({...item, id: idx}));
          wrongCount = data.wrongCount || 0;
          el.sessionName.value = data.name;
          currentSession = data.id;
          initState();
          flash(`ä¼šè¯ "${data.name}" åŠ è½½æˆåŠŸï¼`, 'success');
          switchTab('train');
          checkForce();
        } else {
          flash('åŠ è½½å¤±è´¥ï¼Œä¼šè¯ä¸å­˜åœ¨ã€‚', 'bad');
        }
        res(data);
      };
      req.onerror = rej;
    });
  });

  // åˆ é™¤ä¼šè¯
  const deleteSession = safeAsync(async (sessionId) => {
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    await new Promise((res, rej) => {
      const req = store.delete(sessionId);
      req.onsuccess = () => { res(); if (currentSession === sessionId) { currentSession = null; items = []; initState(); forceLocked = false; } };
      req.onerror = rej;
    });
    flash('ä¼šè¯å·²åˆ é™¤ã€‚', 'warn');
    renderSessions();
  });

  // è§£æè¾“å…¥ (åŠ å¼ºéªŒè¯)
  function parseText(text) {
    const lines = text.split(/\r?\n/).map(s => s.trim()).filter(line => line && !/^\s*$/.test(line));
    const out = [];
    for (let i = 0; i < lines.length && out.length < 25; i++) {
      let parts = lines[i].includes('\t') ? lines[i].split('\t') : lines[i].split(',');
      parts = parts.map(s => s.trim()).filter(Boolean);
      if (parts.length >= 2 && parts[0] && parts[1]) {
        const en = parts[0];
        const zh = parts[1];
        const sentence = parts[2] || '';
        out.push({en, zh, sentence, id: out.length, mastered: false, errors: 0, reviews: 0, lastReview: 0, nextReview: Date.now() + 86400000, stubborn: false, efactor: 2.5, repetitions: 0, interval: 0});
      }
    }
    if (out.length > 25) flash('è¾“å…¥è¶…è¿‡25å¯¹ï¼Œå·²æˆªå–å‰25å¯¹ã€‚', 'warn');
    return out;
  }

  // å®æ—¶é¢„è§ˆè®¡æ•°
  el.dataBox.oninput = () => {
    const valid = parseText(el.dataBox.value).length;
    el.previewCount.textContent = `æœ‰æ•ˆè¡Œ: ${valid}`;
  };

  // è§£æJSON
  function parseJSON(json) {
    try {
      const data = JSON.parse(json);
      items = data.items.map((item, idx) => ({...item, id: idx}));
      wrongCount = data.wrongCount || 0;
      initState();
      saveSession();
      flash('JSONå¯¼å…¥æˆåŠŸã€‚', 'success');
    } catch (e) {
      flash('JSONæ ¼å¼æ— æ•ˆã€‚', 'bad');
    }
  }

  // åˆå§‹åŒ–çŠ¶æ€
  function initState() {
    pool = items.map(x => x.id).filter(id => !items[id].mastered);
    shuffle(pool);
    visibleLeft = [];
    visibleRight = [];
    selLeft = selRight = null;
    refill();
    render();
  }

  // éšæœºæ´—ç‰Œ
  function shuffle(a) {
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // è¡¥ä½
  function refill() {
    const want = Math.min(parseInt(el.visibleCount.value || 6), 12);
    visibleLeft = [];
    visibleRight = [];
    const candidates = shuffle(pool.filter(id => !items[id].mastered && visibleLeft.indexOf(id) === -1));
    for (let i = 0; i < want && candidates.length > 0; i++) {
      const nid = candidates[i];
      if (nid !== undefined) visibleLeft.push(nid);
    }
    visibleRight = shuffle([...visibleLeft]);
  }

  // è·å–é¡¹
  function getItem(id) { return items[id]; }

  // æ¸²æŸ“åˆ— (ä¼˜åŒ–é•¿æ–‡æœ¬æŠ˜å )
  function renderCol(side, arr, selId) {
    const wrap = side === 'L' ? el.left : el.right;
    wrap.innerHTML = '';
    arr.forEach(id => {
      const data = getItem(id);
      const btn = document.createElement('button');
      btn.className = 'item' + (selId === id ? ' sel' : '');
      let content = side === 'L' ? data.en : data.zh;
      if (content.length > 20) content = content.substring(0, 20) + '...'; // æŠ˜å é•¿æ–‡æœ¬
      btn.innerHTML = content + `<span class="review-date">ä¸‹æ¬¡å¤ä¹ : ${new Date(data.nextReview).toLocaleDateString()}</span>`;
      if (enableSentence && data.sentence) btn.title = data.sentence;
      btn.onclick = (e) => handleClick(e, side, id);
      if (enableSwipe) {
        btn.ontouchstart = (e) => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; };
        btn.ontouchend = (e) => handleSwipe(e, side, id);
      }
      wrap.appendChild(btn);
    });
  }

  // ç‚¹å‡»å¤„ç†
  function handleClick(e, side, id) {
    if (paused) return;
    e.preventDefault();
    if (side === 'L') selLeft = id;
    else selRight = id;
    render();
    if (selLeft && selRight) setTimeout(() => checkMatch(), 100);
  }

  // æ»‘åŠ¨åŒ¹é… (ç§»åŠ¨ç«¯ä¼˜åŒ–)
  function handleSwipe(e, side, id) {
    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;
    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;
    if (Math.abs(deltaX) > 50 && Math.abs(deltaY) < 50) {
      if (deltaX > 0 && side === 'L') selLeft = id;
      else if (deltaX < 0 && side === 'R') selRight = id;
      render();
      if (selLeft && selRight) checkMatch();
    }
  }

  // æ£€æŸ¥åŒ¹é…
  function checkMatch() {
    if (selLeft === null || selRight === null) return;
    const itemL = getItem(selLeft);
    const leftIdx = visibleLeft.indexOf(selLeft);
    const rightIdx = visibleRight.indexOf(selRight);
    const leftBtn = el.left.children[leftIdx];
    const rightBtn = el.right.children[rightIdx];
    if (selLeft === selRight) {
      speak(itemL.en, false);
      leftBtn.style.transform = 'scale(1.1)';
      rightBtn.style.transform = 'scale(1.1)';
      itemL.mastered = true;
      itemL.reviews++;
      visibleLeft.splice(leftIdx, 1);
      visibleRight.splice(rightIdx, 1);
      selLeft = selRight = null;
      pendingRating = itemL.id;
      el.ratingItem.textContent = `${itemL.en} - ${itemL.zh}`;
      el.ratingModal.style.display = 'flex';
      flash('åŒ¹é…æ­£ç¡®ï¼è¯·è¯„ä¼°è´¨é‡ã€‚', 'good');
      setTimeout(() => {
        render();
        el.loading.classList.remove('active');
        checkForce(); // æ£€æŸ¥è§£é”
      }, 500);
    } else {
      speak('ä¸åŒ¹é…', true);
      leftBtn.classList.add('error');
      rightBtn.classList.add('error');
      itemL.errors++;
      wrongCount++;
      selRight = null;
      flash('ä¸åŒ¹é…ï¼Œå†è¯•ï¼', 'warn');
      if (itemL.errors > 3 && itemL.reviews >= 5) markStubborn(itemL);
      setTimeout(() => {
        leftBtn.classList.remove('error');
        rightBtn.classList.remove('error');
        render();
      }, 500);
    }
    saveSession();
  }

  // è¯„çº§å¤„ç†
  qsa('.rating-btn').forEach(btn => {
    btn.onclick = () => {
      const q = parseInt(btn.dataset.q);
      if (pendingRating !== null) {
        const item = getItem(pendingRating);
        sm2Update(item, q);
        pendingRating = null;
        el.ratingModal.style.display = 'none';
        qsa('.rating-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        flash(`è´¨é‡${q}å·²è®°å½•ï¼Œä¸‹æ¬¡é—´éš”${item.interval}å¤©ã€‚`, 'success');
        if (item.repetitions >= 3) {
          item.mastered = true;
        }
        refill();
        render();
        saveSession();
      }
    };
  });

  // æ ‡è®°é¡½å›º
  function markStubborn(item) {
    item.stubborn = true;
    pool.unshift(item.id);
  }

  // å¼ºåˆ¶æ£€æŸ¥ (ä¼˜åŒ–ï¼šå‹å–„æç¤º + ä¸´æ—¶è·³è¿‡)
  const checkForce = safeAsync(async () => {
    const pending = items.filter(i => !i.mastered && Date.now() >= i.nextReview).length;
    const totalPending = items.filter(i => Date.now() >= i.nextReview).length;
    const pct = totalPending > 0 ? Math.round((totalPending - pending) / totalPending * 100) : 100;
    remainingForce = pending;
    el.remainingCount.textContent = pending;
    if (pct < forceThreshold) {
      forceLocked = true;
      el.forceTip.style.display = 'block';
      el.loadBtn.disabled = true;
      el.dataBox.disabled = true;
      el.demoBtn.disabled = true;
      el.file.disabled = true;
      flash(`éœ€å®Œæˆ${pending}é¡¹å¤ä¹  (å½“å‰${pct}%) è§£é”æ–°è¾“å…¥ã€‚è¿˜å·®${pending}é¡¹å³å¯è§£é”ï¼`, 'warn');
    } else {
      forceLocked = false;
      el.forceTip.style.display = 'none';
      el.loadBtn.disabled = false;
      el.dataBox.disabled = false;
      el.demoBtn.disabled = false;
      el.file.disabled = false;
      flash('å¯è¾“å…¥æ–°å†…å®¹ï¼<span class="badge">è§£é”æˆåŠŸ</span>', 'good');
    }
  });

  // ä¸´æ—¶è·³è¿‡å¼ºåˆ¶
  el.skipForce.onclick = () => {
    if (allowSkipForce && remainingForce <= 2) {
      forceLocked = false;
      el.forceTip.style.display = 'none';
      el.loadBtn.disabled = false;
      el.dataBox.disabled = false;
      el.demoBtn.disabled = false;
      el.file.disabled = false;
      flash('ä¸´æ—¶è·³è¿‡å·²å¯ç”¨ï¼Œå»ºè®®å°½å¿«è¡¥å¤ä¹ ä»¥ä¼˜åŒ–è®°å¿†ã€‚', 'warn');
    } else {
      flash('è·³è¿‡å¤±è´¥ï¼šå‰©ä½™é¡¹è¿‡å¤šæˆ–æœªå¯ç”¨è·³è¿‡ã€‚', 'bad');
    }
  };

  // æ¸²æŸ“
  function render() {
    requestAnimationFrame(() => {
      renderCol('L', visibleLeft, selLeft);
      renderCol('R', visibleRight, selRight);
      const done = items.filter(i => i.mastered).length;
      const total = items.length;
      const pct = total ? Math.round(done / total * 100) : 0;
      el.bar.style.width = pct + '%';
      el.counter.textContent = pct + '%';
      el.stats.textContent = `è¿›åº¦ ${done}/${total} | é”™é¢˜ ${wrongCount}`;
      if (pct >= forceThreshold) checkStubbornCover();
    });
  }

  // æ£€æŸ¥é¡½å›ºè¦†ç›–
  function checkStubbornCover() {
    const stubbornItems = items.filter(i => i.stubborn && !i.mastered);
    if (stubbornItems.length === 0) return;
    const easyItems = items.filter(i => i.nextReview > Date.now() + 60 * 86400000 && !i.stubborn);
    if (easyItems.length > 0) {
      const easy = easyItems[0];
      showConfirm('è¦†ç›–æ˜“é¡¹?', `é¡½å›ºé¡¹å°†æ›¿æ¢${easy.en}ã€‚`, async () => {
        await recycleItem(easy);
        flash('å·²è¦†ç›–ã€‚', 'warn');
        render();
      });
    }
  }

  // é—ªè®¯
  let msgTimer = null;
  function flash(text, kind = '') {
    el.msg.innerHTML = text;
    el.msg.className = kind;
    if (msgTimer) clearTimeout(msgTimer);
    msgTimer = setTimeout(() => { el.msg.innerHTML = ''; el.msg.className = ''; }, 3000);
  }

  // Tabåˆ‡æ¢
  function switchTab(tabName) {
    el.tabs.forEach(t => t.classList.remove('active'));
    el.contents.forEach(c => c.classList.remove('active'));
    qs(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
    qs(`#${tabName}`).classList.add('active');
    if (tabName === 'manage') renderSessions();
    if (tabName === 'review') loadTodayReview();
  }
  el.tabs.forEach(tab => {
    tab.onclick = () => switchTab(tab.dataset.tab);
  });

  // åŠ è½½äº‹ä»¶ (å¼ºåˆ¶é”æ£€æŸ¥)
  el.loadBtn.onclick = safeAsync(async () => {
    if (forceLocked && !allowSkipForce) {
      flash('è¯·å…ˆå®Œæˆå¼ºåˆ¶å¤ä¹ æˆ–å¯ç”¨ä¸´æ—¶è·³è¿‡ã€‚', 'bad');
      return;
    }
    el.loading.classList.add('active');
    if (el.file.files[0] && el.file.files[0].name.endsWith('.json')) {
      const text = await el.file.files[0].text();
      parseJSON(text);
      return;
    }
    items = parseText(el.dataBox.value);
    if (items.length === 0) { flash('æ— æœ‰æ•ˆæ•°æ®ã€‚', 'bad'); el.loading.classList.remove('active'); return; }
    initState();
    await saveSession();
    await checkForce();
    flash(`åŠ è½½${items.length}å¯¹è¯ç»„ã€‚`, 'success');
    el.loading.classList.remove('active');
  });

  el.demoBtn.onclick = () => {
    if (forceLocked && !allowSkipForce) {
      flash('è¯·å…ˆå®Œæˆå¼ºåˆ¶å¤ä¹ ã€‚', 'bad');
      return;
    }
    el.dataBox.value = `take care,å°å¿ƒ,Please take care of yourself.\nrun fast,è·‘å¾—å¿«,The rabbit can run fast.\nlook around,ç¯é¡¾å››å‘¨,Look around before crossing.\nfeel good,æ„Ÿè§‰å¥½,I feel good today.\nbreak down,å´©æºƒ,The car broke down.\nbuild up,ç§¯ç´¯,Build up your skills.\nget along,ç›¸å¤„,We get along well.\nhand in,æäº¤,Hand in your homework.\nlook forward to,æœŸå¾…,I look forward to it.\npay attention to,æ³¨æ„,Pay attention to details.\nput off,æ¨è¿Ÿ,Put off the meeting.\nset up,å»ºç«‹,Set up the tent.\nturn down,æ‹’ç»,Turn down the offer.\ntake off,èµ·é£,The plane takes off.\nwork out,è§£å†³,Work out the problem.`;
    el.loadBtn.click();
  };

  el.ttsBtn.onclick = () => speak('test pronunciation', false);
  el.forceCheck.onclick = checkForce;
  el.file.onchange = () => el.loadBtn.click();
  el.visibleCount.oninput = () => { if (!forceLocked) { refill(); render(); } };
  el.pauseBtn.onclick = () => { paused = !paused; el.pauseBtn.textContent = paused ? 'æ¢å¤' : 'æš‚åœ'; flash(paused ? 'å·²æš‚åœ' : 'å·²æ¢å¤', 'warn'); };
  el.resetBtn.onclick = () => { if (!forceLocked) { initState(); flash('å·²é‡ç½®ã€‚', 'warn'); } };
  el.fullscreenBtn.onclick = () => {
    if (document.fullscreenElement) document.exitFullscreen();
    else document.documentElement.requestFullscreen().catch(() => flash('å…¨å±ä¸æ”¯æŒã€‚', 'warn'));
  };

  // å›é¡¾åŠ è½½
  const loadTodayReview = safeAsync(async () => {
    const todayReview = items.filter(i => !i.mastered && Date.now() >= i.nextReview);
    if (todayReview.length === 0) {
      qs('#reviewList').textContent = 'æ— ä»Šæ—¥å¿…å®¡é¡¹';
      qs('#reviewList').style.display = 'block';
      qs('#reviewGrid').style.display = 'none';
      flash('æ— ä»Šæ—¥å¿…å®¡é¡¹ã€‚', 'muted');
      return;
    }
    items = todayReview.map((i, idx) => ({...i, id: idx}));
    initState();
    qs('#reviewGrid').innerHTML = '<div class="grid"><div class="col"><h2>è‹±æ–‡</h2><div id="leftCol"></div></div><div class="col"><h2>ä¸­æ–‡</h2><div id="rightCol"></div></div></div>';
    el.left = qs('#reviewGrid #leftCol');
    el.right = qs('#reviewGrid #rightCol');
    render();
    qs('#reviewGrid').style.display = 'block';
    qs('#reviewList').style.display = 'none';
    flash(`å·²åŠ è½½${todayReview.length}é¡¹ä»Šæ—¥å¿…å®¡ã€‚`, 'success');
  });
  el.loadReview.onclick = loadTodayReview;

  // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
  const renderSessions = safeAsync(async () => {
    if (!db) return;
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const all = await new Promise((res, rej) => {
      const req = store.getAll();
      req.onsuccess = () => res(req.result);
      req.onerror = rej;
    });
    all.sort((a, b) => b.timestamp - a.timestamp);
    el.sessionList.innerHTML = all.map(s => `
      <div class="list-item">
        <span>${s.name} (${new Date(s.timestamp).toLocaleDateString('zh-CN')}) - ${s.items.length} å¯¹è¯ç»„</span>
        <div>
          <button class="ghost" onclick="loadSession('${s.id}')">åŠ è½½</button>
          <button class="bad ghost" onclick="deleteSession('${s.id}')">åˆ é™¤</button>
        </div>
      </div>
    `).join('');
  });

  // å¯¼å‡ºCSV
  el.exportCSV.onclick = () => {
    const wrongs = items.filter(i => i.errors > 0).map(i => `${i.en},${i.zh},${i.errors}`);
    const csv = 'en,zh,errors\n' + wrongs.join('\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${el.sessionName.value || 'wrongs'}.csv`;
    a.click();
    flash('é”™é¢˜å·²å¯¼å‡ºã€‚', 'success');
  };

  // å¤‡ä»½JSON (äº‘åŒæ­¥ç®€åŒ–)
  el.backupJSON.onclick = () => {
    const data = {items, wrongCount, timestamp: Date.now()};
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${el.sessionName.value || 'backup'}.json`;
    a.click();
    flash('å¤‡ä»½å·²ä¸‹è½½ã€‚å¯å¯¼å…¥å…¶ä»–è®¾å¤‡å®ç°åŒæ­¥ã€‚', 'success');
    updateSyncStatus();
  };

  // äº‘åŒæ­¥
  el.syncCloud.onclick = () => {
    flash('äº‘åŒæ­¥: ä¸‹è½½JSONå¤‡ä»½å¹¶åœ¨å…¶ä»–è®¾å¤‡å¯¼å…¥ã€‚Firebaseé›†æˆéœ€APIå¯†é’¥é…ç½®ã€‚', 'muted');
    el.backupJSON.click();
  };

  function updateSyncStatus() {
    el.syncStatus.innerHTML = 'åŒæ­¥çŠ¶æ€: æœ¬åœ° | <button class="ghost" id="syncCloud">äº‘åŒæ­¥</button>';
  }

  // åˆ é™¤å½“å‰ä¼šè¯
  el.clearSession.onclick = () => {
    if (!currentSession) { flash('æ— å½“å‰ä¼šè¯ã€‚', 'warn'); return; }
    showConfirm('åˆ é™¤ä¼šè¯?', 'ç¡®è®¤åˆ é™¤å½“å‰ä¼šè¯ï¼Ÿ', async () => {
      await deleteSession(currentSession);
    });
  };

  // è®¾ç½®ä¿å­˜
  el.saveSettings.onclick = () => {
    forceThreshold = parseInt(el.forceThreshold.value) || 50;
    enableNotify = el.enableNotify.checked;
    enableTTS = el.enableTTS.checked;
    ttsAccent = el.ttsAccent.value;
    enableSentence = el.enableSentence.checked;
    enableSwipe = el.enableSwipe.checked;
    allowSkipForce = el.allowSkipForce.checked;
    localStorage.setItem('settings', JSON.stringify({forceThreshold, enableNotify, enableTTS, ttsAccent, enableSentence, enableSwipe, allowSkipForce}));
    initTTS();
    flash('è®¾ç½®å·²ä¿å­˜ã€‚', 'success');
  };

  // æ¨¡æ€ç¡®è®¤
  function showConfirm(title, text, onYes) {
    el.confirmTitle.textContent = title;
    el.confirmText.textContent = text;
    el.confirmModal.style.display = 'flex';
    const yesHandler = () => { onYes(); el.confirmModal.style.display = 'none'; };
    el.confirmYes.onclick = yesHandler;
  }
  el.confirmNo.onclick = () => el.confirmModal.style.display = 'none';
  qsa('.close').forEach(c => c.onclick = () => { 
    el.confirmModal.style.display = 'none'; 
    el.recycleModal.style.display = 'none'; 
    el.ratingModal.style.display = 'none'; 
  });

  // å›æ”¶é¡¹
  const recycleItem = safeAsync(async (item) => {
    const tx = db.transaction(RECYCLE_STORE, 'readwrite');
    const store = tx.objectStore(RECYCLE_STORE);
    item.recycleTime = Date.now();
    await new Promise((res, rej) => {
      const req = store.put(item);
      req.onsuccess = res;
      req.onerror = rej;
    });
    items = items.filter(i => i.id !== item.id);
    initState();
  });

  // æ¸²æŸ“å›æ”¶ç«™ (è‡ªåŠ¨æ¸…ç†>30å¤©)
  const renderRecycle = safeAsync(async () => {
    const tx = db.transaction(RECYCLE_STORE, 'readonly');
    const store = tx.objectStore(RECYCLE_STORE);
    const all = await new Promise((res, rej) => {
      const req = store.getAll();
      req.onsuccess = () => res(req.result);
      req.onerror = rej;
    });
    const now = Date.now();
    const valid = all.filter(item => now - (item.recycleTime || 0) <= 30 * 86400000);
    if (valid.length < all.length) {
      await cleanOldRecycle(all.filter(item => now - (item.recycleTime || 0) > 30 * 86400000));
    }
    el.recycleList.innerHTML = valid.map(i => `<div class="list-item"><span>${i.en} - ${i.zh} (${new Date(i.recycleTime).toLocaleDateString()})</span><button class="ghost" onclick="restoreItem('${i.id}')">è¿˜åŸ</button></div>`).join('');
  });
  el.openRecycle.onclick = () => {
    renderRecycle();
    el.recycleModal.style.display = 'flex';
  };

  // æ¸…ç†æ—§å›æ”¶é¡¹
  const cleanOldRecycle = safeAsync(async (oldItems) => {
    const tx = db.transaction(RECYCLE_STORE, 'readwrite');
    const store = tx.objectStore(RECYCLE_STORE);
    for (const item of oldItems) {
      await new Promise((res, rej) => {
        const req = store.delete(item.id);
        req.onsuccess = res;
        req.onerror = rej;
      });
    }
    flash(`${oldItems.length}ä¸ªæ—§é¡¹å·²è‡ªåŠ¨æ¸…ç†ã€‚`, 'warn');
  });

  // è¿˜åŸæ‰€æœ‰
  el.restoreAll.onclick = safeAsync(async () => {
    const tx = db.transaction(RECYCLE_STORE, 'readwrite');
    const store = tx.objectStore(RECYCLE_STORE);
    const all = await new Promise((res, rej) => {
      const req = store.getAll();
      req.onsuccess = () => res(req.result);
      req.onerror = rej;
    });
    items.push(...all);
    await new Promise((res, rej) => {
      const req = store.clear();
      req.onsuccess = res;
      req.onerror = rej;
    });
    initState();
    flash('å·²è¿˜åŸæ‰€æœ‰ã€‚', 'good');
    el.recycleModal.style.display = 'none';
  });

  // è¿˜åŸå•ä¸ª
  window.restoreItem = safeAsync(async (id) => {
    const tx = db.transaction(RECYCLE_STORE, 'readwrite');
    const store = tx.objectStore(RECYCLE_STORE);
    const item = await new Promise((res, rej) => {
      const req = store.get(id);
      req.onsuccess = () => res(req.result);
      req.onerror = rej;
    });
    if (item) {
      items.push(item);
      await new Promise((res, rej) => {
        const req = store.delete(id);
        req.onsuccess = res;
        req.onerror = rej;
      });
      initState();
      renderRecycle();
      flash('å·²è¿˜åŸã€‚', 'good');
    }
  });

  // é€šçŸ¥
  el.notifyOpt.onclick = () => {
    if (Notification.permission !== 'granted') Notification.requestPermission().then(() => flash('é€šçŸ¥æƒé™å·²è¯·æ±‚ã€‚', 'muted'));
    if (enableNotify) flash('é€šçŸ¥å·²å¯ç”¨ï¼Œä¸‹æ¬¡åˆ°æœŸå°†æé†’ã€‚', 'good');
  };
  setInterval(() => {
    if (enableNotify && Notification.permission === 'granted') {
      const pending = items.filter(i => Date.now() >= i.nextReview).length;
      if (pending > 0) new Notification('å¤ä¹ æé†’', {body: `æœ‰${pending}é¡¹å¾…å®¡ã€‚`, icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjNWJjMGJlIi8+CjxwYXRoIGQ9Ik0xMjggMTI4TDk2IDE2MEw2NCAxMjhMOTYgMTYwTDMyIDY0TDY0IDMyTDk2IDY0TDMyIDE2MEw2NCAxMjhMOTYgMTYwTDMyIDMyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjgiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4K'});
    }
  }, 3600000);

  // è‡ªåŠ¨å‹ç¼©>90å¤© + å›æ”¶>30å¤©
  const compressOld = safeAsync(async () => {
    if (!db) return;
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const all = await new Promise((res, rej) => {
      const req = store.getAll();
      req.onsuccess = () => res(req.result);
      req.onerror = rej;
    });
    const now = Date.now();
    for (const s of all) {
      if (now - s.timestamp > 90 * 86400000) {
        await new Promise((res, rej) => {
          const req = store.delete(s.id);
          req.onsuccess = res;
          req.onerror = rej;
        });
      }
    }
    // æ¸…ç†å›æ”¶ç«™
    const recycleTx = db.transaction(RECYCLE_STORE, 'readwrite');
    const recycleStore = recycleTx.objectStore(RECYCLE_STORE);
    const recycles = await new Promise((res, rej) => {
      const req = recycleStore.getAll();
      req.onsuccess = () => res(req.result);
      req.onerror = rej;
    });
    const oldRecycles = recycles.filter(item => now - (item.recycleTime || 0) > 30 * 86400000);
    for (const item of oldRecycles) {
      await new Promise((res, rej) => {
        const req = recycleStore.delete(item.id);
        req.onsuccess = res;
        req.onerror = rej;
      });
    }
    if (oldRecycles.length > 0) flash(`${oldRecycles.length}ä¸ªæ—§å›æ”¶é¡¹å·²æ¸…ç†ã€‚`, 'warn');
  });

  // å¿«æ·é”®
  document.addEventListener('keydown', (e) => {
    if (e.key === ' ' && selLeft && selRight && !paused) { e.preventDefault(); checkMatch(); }
    if (e.key === 'Escape') { paused = false; el.pauseBtn.textContent = 'æš‚åœ'; flash('å·²æ¢å¤ã€‚', 'warn'); }
  });

  // åˆå§‹åŠ è½½
  const init = safeAsync(async () => {
    await initDB();
    await compressOld();
    initTTS();
    const savedSettings = JSON.parse(localStorage.getItem('settings') || '{}');
    forceThreshold = savedSettings.forceThreshold || 50;
    enableNotify = savedSettings.enableNotify || false;
    enableTTS = savedSettings.enableTTS !== false;
    ttsAccent = savedSettings.ttsAccent || 'en-US';
    enableSentence = savedSettings.enableSentence !== false;
    enableSwipe = savedSettings.enableSwipe !== false;
    allowSkipForce = savedSettings.allowSkipForce !== false;
    el.forceThreshold.value = forceThreshold;
    el.enableNotify.checked = enableNotify;
    el.enableTTS.checked = enableTTS;
    el.ttsAccent.value = ttsAccent;
    el.enableSentence.checked = enableSentence;
    el.enableSwipe.checked = enableSwipe;
    el.allowSkipForce.checked = allowSkipForce;
    el.sessionName.value = new Date().toISOString().slice(0, 10) + '-åŸºç¡€';
    el.dataBox.oninput();
    flash('æ¬¢è¿ä½¿ç”¨ï¼ç²˜è´´è¯ç»„åç‚¹å‡»åŠ è½½ã€‚æ”¯æŒSM-2è¯„çº§ä¸JSONåŒæ­¥ã€‚', 'muted');
    if ('serviceWorker' in navigator && 'caches' in window) {
      navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
        const CACHE_NAME = 'match-trainer-v1';
        self.addEventListener('install', e => {
          e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(['./'])));
        });
        self.addEventListener('fetch', e => {
          e.respondWith(caches.match(e.request).then(res => res || fetch(e.request)));
        });
      `));
    }
    checkForce(); // åˆå§‹åŒ–æ£€æŸ¥
  });
  init();

  // å…¨å±€æš´éœ²
  window.loadSession = loadSession;
  window.deleteSession = deleteSession;
})();
</script>
</body>
</html>
